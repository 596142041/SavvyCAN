language: cpp

matrix:
   include:
      - os: linux
        dist: xenial
        compiler: gcc
        sudo: require
        before_install:
           - sudo add-apt-repository ppa:beineri/opt-qt-5.12.3-xenial -y
           - sudo apt-get update -qq

        install:
           - sudo apt-get -y install qt512base qt512connectivity qt512imageformats qt512serialport qt512serialbus qt512doc qt512tools libgl1-mesa-dev
           - source /opt/qt*/bin/qt*-env.sh

        script:
           - qmake CONFIG+=release PREFIX=/usr
           - make -j$(nproc)
           - make INSTALL_ROOT=appdir -j$(nproc) install ; find appdir/
           - wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
           - chmod a+x linuxdeployqt-continuous-x86_64.AppImage
           # export VERSION=... # linuxdeployqt uses this for naming the file
           - ./linuxdeployqt-continuous-x86_64.AppImage appdir/usr/local/share/applications/SavvyCAN.desktop -appimage -extra-plugins=iconengines,platformthemes.libqgtk3.so

        after_success:
           # find appdir -executable -type f -exec ldd {} \; | grep " => /usr" | cut -d " " -f 2-3 | sort | uniq # for debugging
           # curl --upload-file APPNAME*.AppImage https://transfer.sh/APPNAME-git.$(git rev-parse --short HEAD)-x86_64.AppImage
           - wget -c https://github.com/probonopd/uploadtool/raw/master/upload.sh
           - bash upload.sh SavvyCAN*.AppImage*
  
      - os: osx
        osx_image: xcode10
        before_install:
           - brew install qt5
           - brew link qt5 --force
        script:
           - qmake CONFIG+=release -spec macx-xcode SavvyCAN.pro
           - xcodebuild
           - macdeployqt Release/SavvyCAN.app -dmg
      - os: windows
        before_install:
           - dir C:/Program\ Files\ \(x86\)/Windows\ Kits/10/bin/10.0.17134.0/x64
           - cmd.exe /C 'cd && "C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\VC\Auxiliary\Build\vcvarsall.bat" x86 && cd && cd "C:/Users/travis/build/braindef/jamulus" && dir'
           - curl -vLO http://download.qt.io/official_releases/online_installers/qt-unified-windows-x86-online.exe
           - "./qt-unified-windows-x86-online.exe --verbose --script qt-installer-windows.qs"
           - ls -la C:/Qt/5.12.3/msvc2017/bin/qtenv2.bat
        script:
           - cmd.exe /C 'cd && "C:\Qt\5.12.3\msvc2017\bin\qtenv2.bat" && cd && "C:\Program Files (x86)\Microsoft Visual Studio\2017\BuildTools\VC\Auxiliary\Build\vcvarsall.bat" x86 && cd && qmake CONFIG+=RELEASE SavvyCAN.pro && nmake'

branches:
  except:
    - # Do not build tags that we create when we upload to GitHub Releases
    - /^(?i:continuous)/
